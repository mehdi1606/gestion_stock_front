<div class="container-fluid mt-4">
  <!-- Page Title -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="page-title">
      <!-- Show different title based on mode -->
      <span *ngIf="!isEditMode">Your Order</span>
      <span *ngIf="isEditMode">Edit Order #{{editOrderId}}</span>
    </h2>
    <nav>
      <ol class="breadcrumb bg-transparent p-0">
        <li class="breadcrumb-item"><a href="#">Ecommerce</a></li>
        <li class="breadcrumb-item" *ngIf="!isEditMode"><a href="/ecommerce/orders">Orders</a></li>
        <li class="breadcrumb-item" *ngIf="isEditMode"><a href="/ecommerce/orders">Orders</a></li>
        <li class="breadcrumb-item active" aria-current="page">
          {{isEditMode ? 'Edit Order' : 'Order'}}
        </li>
      </ol>
    </nav>
  </div>

  <!-- Cart Details Section -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="card-title mb-0">
              {{isEditMode ? 'Edit Order Details' : 'Create Order'}}
            </h4>
            <!-- Show edit mode indicator -->
            <span *ngIf="isEditMode" class="badge bg-info fs-6">
              <i class="fas fa-edit"></i> Edit Mode
            </span>
          </div>

          <div class="card-body text-center">
            <button class="btn btn-primary" (click)="openProductModal()">
              <i class="fas fa-plus-circle"></i>
              {{isEditMode ? 'Add More Products' : 'Add Products'}}
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Product</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Reduction</th>
                  <th>Total</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of cartData; let i = index">
                  <td>
                    <div class="d-flex align-items-center">
                      <span>{{ product.name }}-{{product.description}}</span>
                    </div>
                  </td>
                  <td>
                    <input type="number" class="form-control" [(ngModel)]="product.qty" min="1" style="width: 70px;">
                  </td>
                  <td>{{ product.price }} MAD</td>
                  <td>{{ product.category === 'Argan' ? '0.00' : getReduction(product) | number:'1.2-2' }} MAD</td>
                  <td>{{ calculateProductTotal(product) | number:'1.2-2' }} MAD</td>
                  <td>
                    <button class="btn btn-outline-danger btn-sm" (click)="removeProduct(i)">
                      <i class="fas fa-trash-alt"></i> Remove
                    </button>
                  </td>
                </tr>
                <!-- Show message when no products in cart -->
                <tr *ngIf="cartData.length === 0">
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <br>
                    {{isEditMode ? 'This order has no products. Add some products to continue.' : 'No products added yet. Click "Add Products" to get started.'}}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Selection and Order Save Section -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h4 class="card-title mb-4">Order Details</h4>

          <div class="form-group">
            <label for="customerSelect">Select Customer</label>
            <select id="customerSelect" class="form-control" [(ngModel)]="selectedCustomerId">
              <option value="" disabled>Choose a customer...</option>
              <option *ngFor="let customer of customers" [value]="customer.id">{{ customer.name }}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="orderDate">Order Date</label>
            <input type="date" id="orderDate" class="form-control" [(ngModel)]="orderDate" />
          </div>

          <div class="form-group">
            <label for="documentType">Document Type</label>
            <select id="documentType" class="form-control" [(ngModel)]="documentType">
              <option value="" disabled>Select document type...</option>
              <option value="FACTURE">Facture</option>
              <option value="BON_DE_LIVRAISON">Bon de Livraison</option>
            </select>
          </div>

          <div class="form-group">
            <label for="reductionPercentage">Reduction Percentage (%)</label>
            <input
              type="number"
              id="reductionPercentage"
              class="form-control"
              [(ngModel)]="reductionPercentage"
              (change)="applyReductionToProducts()"
              min="0"
              max="100"
              placeholder="Enter reduction percentage for eligible products"
            />
          </div>

          <div class="form-group">
            <label for="paymentAmount">Payment Amount</label>
            <input type="number" id="paymentAmount" class="form-control" [(ngModel)]="paymentAmount" min="0" />
          </div>

          <!-- Total Calculation Display -->
          <div class="d-flex flex-column align-items-start mt-4">
            <div *ngIf="documentType === 'FACTURE'">
              <div><strong>Total HT: {{ calculateSubTotal() | number: '1.2-2' }} MAD</strong></div>
              <div><strong>TVA 20%: {{ calculateTotalTVA() | number: '1.2-2' }} MAD</strong></div>
              <div><strong>Total TTC: {{ calculateTotal() | number: '1.2-2' }} MAD</strong></div>
            </div>

            <div *ngIf="documentType === 'BON_DE_LIVRAISON'">
              <strong>Total: {{ calculateSubTotal() | number: '1.2-2' }} MAD</strong>
            </div>

            <!-- Action buttons -->
            <div class="mt-3 d-flex gap-2 w-100">
              <!-- Cancel button (only show in edit mode) -->
              <button *ngIf="isEditMode" class="btn btn-secondary" (click)="cancelEdit()">
                <i class="fas fa-times"></i> Cancel
              </button>

              <!-- Save/Update button -->
              <button class="btn btn-success flex-fill" (click)="saveOrder()">
                <i class="fas fa-save"></i>
                {{isEditMode ? 'Update Order' : 'Save Order'}}
              </button>
            </div>

            <!-- Show additional info in edit mode -->
            <div *ngIf="isEditMode" class="mt-3 p-3 bg-light rounded w-100">
              <small class="text-muted">
                <strong>Note:</strong> Updating this order will modify the existing order data.
                Any payments already made will be preserved unless you change the payment amount.
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>