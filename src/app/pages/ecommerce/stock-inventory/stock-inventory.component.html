<!-- stock-inventory.component.html - VERSION CORRIGÉE -->
<div class="stock-inventory-container">

  <!-- ===============================
       HEADER ET STATISTIQUES
       =============================== -->

  <!-- Header principal -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <div class="page-title-section">
          <h4 class="mb-sm-0 font-size-18">
            <i class="bx bx-package me-2"></i>
            Inventaire des Stocks
          </h4>
          <div class="page-title-right" *ngIf="lastUpdate">
            <small class="text-muted">
              <i class="bx bx-time me-1"></i>
              Dernière mise à jour: {{ formatDate(lastUpdate) }}
            </small>
          </div>
        </div>

        <div class="page-title-right">
          <div class="btn-group" role="group">
            <button type="button"
                    class="btn btn-outline-primary btn-sm"
                    (click)="onRefresh()"
                    [disabled]="loading">
              <i class="bx bx-refresh" [class.spinning]="loading"></i>
              Actualiser
            </button>

            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    (click)="onToggleStatistics()">
              <i class="bx" [ngClass]="showStatistics ? 'bx-hide' : 'bx-show'"></i>
              {{ showStatistics ? 'Masquer' : 'Afficher' }} stats
            </button>

            <button type="button"
                    class="btn btn-primary btn-sm"
                    *ngIf="enableExport"
                    (click)="onExport()">
              <i class="bx bx-download me-1"></i>
              Exporter
            </button>

            <button type="button"
                    class="btn btn-info btn-sm"
                    (click)="debugApiCall()">
              <i class="bx bx-bug me-1"></i>
              Debug
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section statistiques modernes -->
  <div class="row mb-4" *ngIf="showStatistics">
    <div class="col-12">
      <div class="stats-modern-container">
        <!-- Header de section -->
        <div class="stats-header">
          <div class="stats-header-icon">
            <i class="bx bx-bar-chart-alt-2"></i>
          </div>
          <div class="stats-header-content">
            <h6 class="stats-title">Statistiques des Stocks</h6>
            <p class="stats-subtitle">Vue d'ensemble temps réel</p>
          </div>
        </div>

        <!-- Grille des statistiques -->
        <div class="modern-stats-grid">
          <!-- Total Articles -->
          <div class="modern-stats-item total-articles">
            <div class="stats-card-wrapper">
              <div class="stats-icon-wrapper">
                <div class="stats-icon bg-primary-gradient">
                  <i class="bx bx-package"></i>
                </div>
              </div>

              <div class="stats-content-wrapper">
                <div class="stats-meta">
                  <span class="stats-label">Total Articles</span>
                  <span class="stats-badge">Inventaire</span>
                </div>
                <div class="stats-number">{{ statistics.totalStocks }}</div>
                <div class="stats-trend trend-positive">
                  <i class="bx bx-trending-up"></i>
                  <span>Suivi actif</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Valeur Totale -->
          <div class="modern-stats-item total-value">
            <div class="stats-card-wrapper">
              <div class="stats-icon-wrapper">
                <div class="stats-icon bg-success-gradient">
                  <i class="bx bx-money"></i>
                </div>
              </div>

              <div class="stats-content-wrapper">
                <div class="stats-meta">
                  <span class="stats-label">Valeur Totale</span>
                  <span class="stats-badge">MAD</span>
                </div>
                <div class="stats-number">{{ formatCurrency(statistics.totalValue) }}</div>
                <div class="stats-trend trend-positive">
                  <i class="bx bx-trending-up"></i>
                  <span>Performance stable</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Stocks Critiques -->
          <div class="modern-stats-item critical-stocks clickable"
               [class.pulse-animation]="statistics.criticalCount > 0"
               (click)="onCriticalFilter()">
            <div class="stats-card-wrapper">
              <div class="stats-icon-wrapper">
                <div class="stats-icon bg-danger-gradient">
                  <i class="bx bx-error"></i>
                </div>
              </div>

              <div class="stats-content-wrapper">
                <div class="stats-meta">
                  <span class="stats-label">Stocks Critiques</span>
                  <span class="stats-badge urgent">Urgent</span>
                </div>
                <div class="stats-number">{{ statistics.criticalCount }}</div>
                <div class="stats-trend trend-negative" *ngIf="statistics.criticalCount > 0">
                  <i class="bx bx-error-circle"></i>
                  <span>Action requise</span>
                </div>
                <div class="stats-trend trend-neutral" *ngIf="statistics.criticalCount === 0">
                  <i class="bx bx-check-circle"></i>
                  <span>Aucun critique</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Stocks Faibles -->
          <div class="modern-stats-item low-stocks clickable"
               (click)="onLowStockFilter()">
            <div class="stats-card-wrapper">
              <div class="stats-icon-wrapper">
                <div class="stats-icon bg-warning-gradient">
                  <i class="bx bx-error-alt"></i>
                </div>
              </div>

              <div class="stats-content-wrapper">
                <div class="stats-meta">
                  <span class="stats-label">Stocks Faibles</span>
                  <span class="stats-badge warning">Attention</span>
                </div>
                <div class="stats-number">{{ statistics.lowCount }}</div>
                <div class="stats-trend trend-neutral">
                  <i class="bx bx-time"></i>
                  <span>Surveillance</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Stocks Vides -->
          <div class="modern-stats-item empty-stocks clickable"
               (click)="onEmptyStockFilter()">
            <div class="stats-card-wrapper">
              <div class="stats-icon-wrapper">
                <div class="stats-icon bg-secondary-gradient">
                  <i class="bx bx-minus-circle"></i>
                </div>
              </div>

              <div class="stats-content-wrapper">
                <div class="stats-meta">
                  <span class="stats-label">Stocks Vides</span>
                  <span class="stats-badge">Rupture</span>
                </div>
                <div class="stats-number">{{ statistics.emptyCount }}</div>
                <div class="stats-trend trend-negative" *ngIf="statistics.emptyCount > 0">
                  <i class="bx bx-trending-down"></i>
                  <span>Réappro. requis</span>
                </div>
                <div class="stats-trend trend-positive" *ngIf="statistics.emptyCount === 0">
                  <i class="bx bx-check"></i>
                  <span>Stock disponible</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Stocks Normaux -->
          <div class="modern-stats-item normal-stocks">
            <div class="stats-card-wrapper">
              <div class="stats-icon-wrapper">
                <div class="stats-icon bg-info-gradient">
                  <i class="bx bx-check-circle"></i>
                </div>
              </div>

              <div class="stats-content-wrapper">
                <div class="stats-meta">
                  <span class="stats-label">Stocks Normaux</span>
                  <span class="stats-badge success">Optimal</span>
                </div>
                <div class="stats-number">{{ statistics.normalCount }}</div>
                <div class="stats-trend trend-positive">
                  <i class="bx bx-trending-up"></i>
                  <span>Situation saine</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===============================
       BARRE D'OUTILS ET FILTRES
       =============================== -->

  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row align-items-center">
            <!-- Barre de recherche -->
            <div class="col-lg-4 col-md-6">
              <div class="search-box position-relative">
                <input type="text"
                       class="form-control search-input"
                       placeholder="Rechercher un article..."
                       [value]="currentFilterState.searchTerm"
                       (input)="onSearchChange($event.target.value)">
                <i class="bx bx-search search-icon"></i>
              </div>
            </div>

            <!-- Filtres rapides -->
            <div class="col-lg-5 col-md-6">
              <div class="d-flex gap-2 flex-wrap">
                <button type="button"
                        class="btn btn-sm"
                        [ngClass]="currentFilterState.showCriticalOnly ? 'btn-danger' : 'btn-outline-danger'"
                        (click)="onCriticalFilter()">
                  <i class="bx bx-error me-1"></i>
                  Critiques ({{ statistics.criticalCount }})
                </button>

                <button type="button"
                        class="btn btn-sm"
                        [ngClass]="currentFilterState.showLowOnly ? 'btn-warning' : 'btn-outline-warning'"
                        (click)="onLowStockFilter()">
                  <i class="bx bx-error-alt me-1"></i>
                  Faibles ({{ statistics.lowCount }})
                </button>

                <button type="button"
                        class="btn btn-sm"
                        [ngClass]="currentFilterState.showEmptyOnly ? 'btn-secondary' : 'btn-outline-secondary'"
                        (click)="onEmptyStockFilter()">
                  <i class="bx bx-minus-circle me-1"></i>
                  Vides ({{ statistics.emptyCount }})
                </button>
              </div>
            </div>

            <!-- Contrôles d'affichage -->
            <div class="col-lg-3">
              <div class="d-flex align-items-center gap-2">
                <!-- Sélecteur de catégorie -->
                <select class="form-select form-select-sm"
                        [value]="currentFilterState.selectedCategory"
                        (change)="onCategoryFilter($event.target.value)">
                  <option value="">Toutes catégories</option>
                  <option *ngFor="let category of categories" [value]="category">
                    {{ category }}
                  </option>
                </select>

                <!-- Modes d'affichage -->
                <div class="btn-group btn-group-sm" role="group">
                  <input type="radio" class="btn-check" name="viewMode"
                         id="view-table" value="table"
                         [checked]="view === 'table'"
                         (change)="onViewChange('table')">
                  <label class="btn btn-outline-primary" for="view-table" title="Tableau">
                    <i class="bx bx-table"></i>
                  </label>

                  <input type="radio" class="btn-check" name="viewMode"
                         id="view-cards" value="cards"
                         [checked]="view === 'cards'"
                         (change)="onViewChange('cards')">
                  <label class="btn btn-outline-primary" for="view-cards" title="Cartes">
                    <i class="bx bx-grid-alt"></i>
                  </label>
                </div>

                <!-- Bouton reset filtres -->
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        title="Réinitialiser les filtres"
                        (click)="onResetFilters()"
                        *ngIf="currentFilterState.searchTerm || currentFilterState.selectedCategory ||
                               currentFilterState.showCriticalOnly || currentFilterState.showLowOnly ||
                               currentFilterState.showEmptyOnly">
                  <i class="bx bx-x"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions en lot -->
  <div class="row mb-3" *ngIf="hasSelection && enableBulkActions">
    <div class="col-12">
      <div class="alert alert-info d-flex align-items-center justify-content-between" role="alert">
        <div class="d-flex align-items-center">
          <i class="bx bx-check-square me-2"></i>
          <span>{{ selectedStocks.size }} article(s) sélectionné(s)</span>
        </div>

        <div class="btn-group btn-group-sm">
          <button type="button" class="btn btn-outline-primary" (click)="onBulkAction('export')">
            <i class="bx bx-download me-1"></i>
            Exporter
          </button>

          <button type="button" class="btn btn-outline-info" (click)="onBulkAction('inventory')">
            <i class="bx bx-package me-1"></i>
            Inventaire
          </button>

          <button type="button" class="btn btn-outline-warning" (click)="onBulkAction('alert')">
            <i class="bx bx-bell me-1"></i>
            Alerte
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===============================
       CONTENU PRINCIPAL
       =============================== -->

  <!-- État de chargement -->
  <div class="row" *ngIf="loading">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-3 mb-0">Chargement des données...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div class="row" *ngIf="error && !loading">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        <div class="d-flex align-items-start">
          <div class="avatar-sm me-3">
            <div class="avatar-title bg-danger-subtle text-danger rounded-circle">
              <i class="bx bx-error-circle font-size-18"></i>
            </div>
          </div>
          <div class="flex-grow-1">
            <h5 class="alert-heading">Erreur de chargement</h5>
            <p class="mb-3">{{ error }}</p>
            <hr>
            <div class="d-flex">
              <button type="button" class="btn btn-outline-danger btn-sm me-2" (click)="onRefresh()">
                <i class="bx bx-refresh me-1"></i>
                Réessayer
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="debugApiCall()">
                <i class="bx bx-bug me-1"></i>
                Voir détails
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Liste vide -->
  <div class="row" *ngIf="!loading && !error && stocks.length === 0">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <div class="avatar-lg mx-auto mb-4">
            <div class="avatar-title bg-light text-muted rounded-circle font-size-20">
              <i class="bx bx-package"></i>
            </div>
          </div>
          <h5 class="mb-3">Aucun stock trouvé</h5>
          <p class="text-muted mb-4" *ngIf="currentFilterState.searchTerm">
            Aucun résultat pour "{{ currentFilterState.searchTerm }}"
          </p>
          <p class="text-muted mb-4" *ngIf="!currentFilterState.searchTerm">
            Aucun article en stock pour le moment
          </p>
          <button type="button"
                  class="btn btn-outline-primary"
                  (click)="onResetFilters()"
                  *ngIf="currentFilterState.searchTerm || currentFilterState.selectedCategory">
            <i class="bx bx-x me-1"></i>
            Effacer les filtres
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===============================
       AFFICHAGE TABLEAU
       =============================== -->

  <div class="row" *ngIf="!loading && !error && stocks.length > 0 && view === 'table'">
    <div class="col-12">
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-nowrap align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <!-- Colonne de sélection -->
                  <th style="width: 20px;" *ngIf="enableBulkActions">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox"
                             [checked]="selectedStocks.size === stocks.length && stocks.length > 0"
                             [indeterminate]="selectedStocks.size > 0 && selectedStocks.size < stocks.length"
                             (change)="onSelectAllRows()">
                    </div>
                  </th>

                  <!-- Colonne Statut -->
                  <th style="width: 80px;">Statut</th>

                  <!-- Colonne Article -->
                  <th class="sortable cursor-pointer" (click)="onSort('articleNom')">
                    Article
                    <i class="bx font-size-12 ms-1"
                       [ngClass]="getSortDirection('articleNom') === 'asc' ? 'bx-up-arrow-alt' :
                                  getSortDirection('articleNom') === 'desc' ? 'bx-down-arrow-alt' : 'bx-transfer-alt'"></i>
                  </th>

                  <!-- Colonne Quantités -->
                  <th class="sortable cursor-pointer" (click)="onSort('quantiteActuelle')">
                    Quantités
                    <i class="bx font-size-12 ms-1"
                       [ngClass]="getSortDirection('quantiteActuelle') === 'asc' ? 'bx-up-arrow-alt' :
                                  getSortDirection('quantiteActuelle') === 'desc' ? 'bx-down-arrow-alt' : 'bx-transfer-alt'"></i>
                  </th>

                  <!-- Colonne Valeur -->
                  <th class="sortable cursor-pointer" (click)="onSort('valeurStock')">
                    Valeur
                    <i class="bx font-size-12 ms-1"
                       [ngClass]="getSortDirection('valeurStock') === 'asc' ? 'bx-up-arrow-alt' :
                                  getSortDirection('valeurStock') === 'desc' ? 'bx-down-arrow-alt' : 'bx-transfer-alt'"></i>
                  </th>

                  <!-- Colonne Dernière activité -->
                  <th class="sortable cursor-pointer" (click)="onSort('dateModification')">
                    Dernière activité
                    <i class="bx font-size-12 ms-1"
                       [ngClass]="getSortDirection('dateModification') === 'asc' ? 'bx-up-arrow-alt' :
                                  getSortDirection('dateModification') === 'desc' ? 'bx-down-arrow-alt' : 'bx-transfer-alt'"></i>
                  </th>

                  <!-- Colonne Actions -->
                  <th style="width: 120px;">Actions</th>
                </tr>
              </thead>

              <tbody>
                <ng-container *ngFor="let stock of stocks; trackBy: trackByStockId">
                  <!-- Ligne principale -->
                  <tr [ngClass]="getStockStatusClass(stock)"
                      [class.table-active]="selectedStocks.has(stock.id)"
                      (click)="onStockSelect(stock)">

                    <!-- Sélection -->
                    <td *ngIf="enableBulkActions" (click)="$event.stopPropagation()">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               [checked]="selectedStocks.has(stock.id)"
                               (change)="onToggleRowSelection(stock.id)">
                      </div>
                    </td>

                    <!-- Statut -->
                    <td>
                      <span class="badge badge-pill" [ngClass]="getStockStatusBadgeClass(stock)">
                        <i [ngClass]="getStockStatusIcon(stock)" class="me-1"></i>
                        {{ stock.statutStock }}
                      </span>
                    </td>

                    <!-- Article -->
                    <td>
                      <div>
                        <h6 class="mb-1">{{ getDisplayName(stock) }}</h6>
                        <div class="d-flex gap-2 font-size-12 text-muted">
                          <span>ID: {{ getArticleCode(stock) }}</span>
                          <span *ngIf="stock.articleCategorie">| {{ stock.articleCategorie }}</span>
                        </div>
                      </div>
                    </td>

                    <!-- Quantités -->
                    <td>
                      <div class="quantities-info">
                        <div class="d-flex align-items-baseline mb-1">
                          <h6 class="mb-0 me-1">{{ stock.quantiteActuelle }}</h6>
                          <small class="text-muted" *ngIf="stock.articleUnite">{{ stock.articleUnite }}</small>
                        </div>
                        <div class="d-flex gap-2 font-size-12">
                          <span class="text-warning" *ngIf="stock.quantiteReservee > 0">
                            Rés: {{ stock.quantiteReservee }}
                          </span>
                          <span class="text-success">
                            Disp: {{ stock.quantiteDisponible }}
                          </span>
                        </div>
                        <div class="d-flex gap-2 font-size-11 text-muted"
                             *ngIf="stock.articleStockMin || stock.articleStockMax">
                          <span *ngIf="stock.articleStockMin">Min: {{ stock.articleStockMin }}</span>
                          <span *ngIf="stock.articleStockMax">Max: {{ stock.articleStockMax }}</span>
                        </div>
                      </div>
                    </td>

                    <!-- Valeur -->
                    <td>
                      <div class="value-info">
                        <h6 class="mb-1 text-success">{{ formatCurrency(stock.valeurStock) }}</h6>
                        <p class="text-muted mb-0 font-size-12">
                          PMP: {{ formatCurrency(stock.prixMoyenPondere) }}
                        </p>
                      </div>
                    </td>

                    <!-- Dernière activité -->
                    <td>
                      <div class="activity-info font-size-12">
                        <div class="d-flex align-items-center mb-1" *ngIf="stock.derniereEntree">
                          <i class="bx bx-plus-circle text-success me-1"></i>
                          <span>{{ formatDate(stock.derniereEntree) }}</span>
                        </div>
                        <div class="d-flex align-items-center mb-1" *ngIf="stock.derniereSortie">
                          <i class="bx bx-minus-circle text-danger me-1"></i>
                          <span>{{ formatDate(stock.derniereSortie) }}</span>
                        </div>
                        <div class="d-flex align-items-center" *ngIf="!stock.derniereEntree && !stock.derniereSortie">
                          <i class="bx bx-edit text-muted me-1"></i>
                          <span>{{ formatDate(stock.dateModification) }}</span>
                        </div>
                      </div>
                    </td>

                    <!-- Actions -->
                    <td (click)="$event.stopPropagation()">
                      <div class="d-flex gap-1">
                        <button type="button"
                                class="btn btn-outline-primary btn-sm"
                                title="Voir détails"
                                (click)="onStockView(stock)">
                          <i class="bx bx-show"></i>
                        </button>

                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                title="Modifier"
                                (click)="onStockEdit(stock.id)">
                          <i class="bx bx-edit"></i>
                        </button>

                        <button type="button"
                                class="btn btn-outline-dark btn-sm"
                                title="Détails étendus"
                                (click)="onToggleExpandRow(stock.id)">
                          <i class="bx" [ngClass]="expandedRows.has(stock.id) ? 'bx-chevron-up' : 'bx-chevron-down'"></i>
                        </button>
                      </div>
                    </td>
                  </tr>

                  <!-- Ligne détails étendues -->
                  <tr *ngIf="expandedRows.has(stock.id)">
                    <td [attr.colspan]="enableBulkActions ? 7 : 6" class="p-0">
                      <div class="bg-light p-3 border-top">
                        <div class="row">
                          <div class="col-md-6">
                            <h6 class="mb-3">Informations détaillées</h6>
                            <div class="table-responsive">
                              <table class="table table-sm table-borderless mb-0">
                                <tr>
                                  <td class="fw-medium">ID Article:</td>
                                  <td>{{ stock.articleId }}</td>
                                </tr>
                                <tr>
                                  <td class="fw-medium">Taux de rotation:</td>
                                  <td>{{ stock.rotationRate }}%</td>
                                </tr>
                                <tr>
                                  <td class="fw-medium">Couleur statut:</td>
                                  <td>
                                    <span class="badge" [style.background-color]="stock.stockStatusColor">
                                      {{ stock.stockStatusColor }}
                                    </span>
                                  </td>
                                </tr>
                                <tr *ngIf="stock.quantiteInventaire">
                                  <td class="fw-medium">Qté Inventaire:</td>
                                  <td>{{ stock.quantiteInventaire }}</td>
                                </tr>
                                <tr *ngIf="stock.ecartInventaire">
                                  <td class="fw-medium">Écart Inventaire:</td>
                                  <td [class.text-danger]="stock.ecartInventaire < 0">
                                    {{ stock.ecartInventaire }}
                                  </td>
                                </tr>
                                <tr *ngIf="stock.dateDernierInventaire">
                                  <td class="fw-medium">Dernier Inventaire:</td>
                                  <td>{{ formatDate(stock.dateDernierInventaire) }}</td>
                                </tr>
                              </table>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <h6 class="mb-3">Alertes de stock</h6>
                            <div class="d-flex flex-column gap-2">
                              <div class="d-flex align-items-center" *ngIf="stock.stockCritique">
                                <i class="bx bx-error text-danger me-2"></i>
                                <span class="text-danger">Stock critique</span>
                              </div>
                              <div class="d-flex align-items-center" *ngIf="stock.stockExcessif">
                                <i class="bx bx-info-circle text-info me-2"></i>
                                <span class="text-info">Stock excessif</span>
                              </div>
                              <div class="d-flex align-items-center" *ngIf="!stock.stockCritique && !stock.stockFaible && !stock.stockExcessif">
                                <i class="bx bx-check-circle text-success me-2"></i>
                                <span class="text-success">Stock normal</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===============================
       AFFICHAGE CARTES
       =============================== -->

  <div class="row" *ngIf="!loading && !error && stocks.length > 0 && view === 'cards'">
    <div class="col-xl-4 col-lg-6 col-md-6" *ngFor="let stock of stocks; trackBy: trackByStockId">
      <div class="card stock-card h-100"
           [ngClass]="getStockStatusClass(stock)"
           (click)="onStockSelect(stock)">

        <!-- Header de carte -->
        <div class="card-header d-flex align-items-center">
          <div class="avatar-sm me-3">
            <span class="avatar-title rounded-circle" [ngClass]="getStockStatusBadgeClass(stock)">
              <i [ngClass]="getStockStatusIcon(stock)"></i>
            </span>
          </div>

          <div class="flex-grow-1">
            <h5 class="card-title mb-1">{{ getArticleCode(stock) }}</h5>
            <p class="card-subtitle text-muted mb-0">{{ getDisplayName(stock) }}</p>
          </div>

          <div class="card-actions" *ngIf="enableBulkActions" (click)="$event.stopPropagation()">
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                     [checked]="selectedStocks.has(stock.id)"
                     (change)="onToggleRowSelection(stock.id)">
            </div>
          </div>
        </div>

        <!-- Contenu de carte -->
        <div class="card-body">
          <div class="row">
            <div class="col-6">
              <div class="text-center">
                <h4 class="mb-1">
                  {{ stock.quantiteActuelle }}
                  <small class="text-muted" *ngIf="stock.articleUnite">{{ stock.articleUnite }}</small>
                </h4>
                <span class="badge" [ngClass]="getStockStatusBadgeClass(stock)">
                  {{ stock.statutStock }}
                </span>
              </div>
            </div>

            <div class="col-6">
              <div class="text-center">
                <h5 class="text-success mb-1">{{ formatCurrency(stock.valeurStock) }}</h5>
                <p class="text-muted mb-0 font-size-12">
                  PMP: {{ formatCurrency(stock.prixMoyenPondere) }}
                </p>
              </div>
            </div>
          </div>

          <hr class="my-3">

          <div class="row font-size-13">
            <div class="col-6" *ngIf="stock.quantiteReservee > 0">
              <div class="d-flex align-items-center">
                <i class="bx bx-lock text-warning me-2"></i>
                <span>Réservé: {{ stock.quantiteReservee }}</span>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex align-items-center">
                <i class="bx bx-check-circle text-success me-2"></i>
                <span>Disponible: {{ stock.quantiteDisponible }}</span>
              </div>
            </div>
            <div class="col-12 mt-2" *ngIf="stock.articleCategorie">
              <div class="d-flex align-items-center">
                <i class="bx bx-category text-info me-2"></i>
                <span>{{ stock.articleCategorie }}</span>
              </div>
            </div>
          </div>

          <!-- Alertes visuelles -->
          <div class="mt-3" *ngIf="stock.stockCritique || stock.stockFaible || stock.stockExcessif">
            <div class="alert alert-sm p-2 mb-0"
                 [ngClass]="stock.stockCritique ? 'alert-danger' :
                           stock.stockFaible ? 'alert-warning' :
                           'alert-info'">
              <div class="d-flex align-items-center">
                <i class="bx me-1"
                   [ngClass]="stock.stockCritique ? 'bx-error' :
                             stock.stockFaible ? 'bx-error-alt' :
                             'bx-info-circle'"></i>
                <small>
                  <span *ngIf="stock.stockCritique">Stock critique - Action immédiate requise</span>
                  <span *ngIf="stock.stockFaible && !stock.stockCritique">Stock faible - Réapprovisionnement recommandé</span>
                  <span *ngIf="stock.stockExcessif && !stock.stockCritique && !stock.stockFaible">Stock excessif - Optimisation possible</span>
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions de carte -->
        <div class="card-footer bg-transparent border-top" (click)="$event.stopPropagation()">
          <div class="d-flex gap-1">
            <button type="button"
                    class="btn btn-outline-primary btn-sm flex-fill"
                    (click)="onStockView(stock)">
              <i class="bx bx-show me-1"></i>
              Voir
            </button>
            <button type="button"
                    class="btn btn-outline-secondary btn-sm flex-fill"
                    (click)="onStockEdit(stock.id)">
              <i class="bx bx-edit me-1"></i>
              Modifier
            </button>
            <button type="button"
                    class="btn btn-outline-info btn-sm"
                    title="Historique"
                    (click)="onToggleExpandRow(stock.id)">
              <i class="bx bx-history"></i>
            </button>
          </div>

          <!-- Détails étendus pour les cartes -->
          <div class="mt-3" *ngIf="expandedRows.has(stock.id)">
            <hr class="my-2">
            <div class="expanded-details">
              <h6 class="mb-2 font-size-12 text-uppercase text-muted">Détails supplémentaires</h6>

              <div class="row font-size-11">
                <div class="col-6">
                  <div class="detail-item mb-1">
                    <span class="text-muted">ID Article:</span>
                    <span class="fw-medium">{{ stock.articleId }}</span>
                  </div>
                  <div class="detail-item mb-1" *ngIf="stock.articleStockMin">
                    <span class="text-muted">Stock Min:</span>
                    <span class="fw-medium">{{ stock.articleStockMin }}</span>
                  </div>
                  <div class="detail-item mb-1" *ngIf="stock.articleStockMax">
                    <span class="text-muted">Stock Max:</span>
                    <span class="fw-medium">{{ stock.articleStockMax }}</span>
                  </div>
                </div>
                <div class="col-6">
                  <div class="detail-item mb-1">
                    <span class="text-muted">Rotation:</span>
                    <span class="fw-medium">{{ stock.rotationRate }}%</span>
                  </div>
                  <div class="detail-item mb-1" *ngIf="stock.derniereEntree">
                    <span class="text-muted">Dernière entrée:</span>
                    <span class="fw-medium">{{ formatDate(stock.derniereEntree) }}</span>
                  </div>
                  <div class="detail-item mb-1" *ngIf="stock.derniereSortie">
                    <span class="text-muted">Dernière sortie:</span>
                    <span class="fw-medium">{{ formatDate(stock.derniereSortie) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===============================
       PAGINATION
       =============================== -->

  <div class="row" *ngIf="!loading && !error && stocks.length > 0 && totalPages > 1">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between flex-wrap">
            <!-- Info pagination -->
            <div class="pagination-info mb-2 mb-md-0">
              <span class="text-muted">{{ paginationInfo }}</span>
            </div>

            <!-- Contrôles pagination -->
            <div class="d-flex align-items-center gap-3 flex-wrap">
              <!-- Taille de page -->
              <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-2 text-nowrap">Lignes par page:</label>
                <select class="form-select form-select-sm"
                        style="width: 80px;"
                        [value]="currentPaginationState.size"
                        (change)="onPageSizeChange(+$event.target.value)">
                  <option *ngFor="let size of pageSizeOptions" [value]="size">
                    {{ size }}
                  </option>
                </select>
              </div>

              <!-- Navigation pagination -->
              <nav aria-label="Pagination">
                <ul class="pagination pagination-sm mb-0">
                  <!-- Première page -->
                  <li class="page-item" [class.disabled]="isFirstPage">
                    <a class="page-link"
                       href="javascript:void(0)"
                       (click)="!isFirstPage && onPageChange(0)"
                       aria-label="Première page">
                      <i class="bx bx-chevrons-left"></i>
                    </a>
                  </li>

                  <!-- Page précédente -->
                  <li class="page-item" [class.disabled]="isFirstPage">
                    <a class="page-link"
                       href="javascript:void(0)"
                       (click)="!isFirstPage && onPageChange(currentPaginationState.page - 1)"
                       aria-label="Page précédente">
                      <i class="bx bx-chevron-left"></i>
                    </a>
                  </li>

                  <!-- Ellipse début -->
                  <li class="page-item disabled" *ngIf="paginationPages.length > 0 && paginationPages[0] > 0">
                    <span class="page-link">...</span>
                  </li>

                  <!-- Pages numérotées -->
                  <li class="page-item"
                      *ngFor="let page of paginationPages"
                      [class.active]="page === currentPaginationState.page">
                    <a class="page-link"
                       href="javascript:void(0)"
                       (click)="onPageChange(page)">
                      {{ page + 1 }}
                    </a>
                  </li>

                  <!-- Ellipse fin -->
                  <li class="page-item disabled"
                      *ngIf="paginationPages.length > 0 && paginationPages[paginationPages.length - 1] < totalPages - 1">
                    <span class="page-link">...</span>
                  </li>

                  <!-- Page suivante -->
                  <li class="page-item" [class.disabled]="isLastPage">
                    <a class="page-link"
                       href="javascript:void(0)"
                       (click)="!isLastPage && onPageChange(currentPaginationState.page + 1)"
                       aria-label="Page suivante">
                      <i class="bx bx-chevron-right"></i>
                    </a>
                  </li>

                  <!-- Dernière page -->
                  <li class="page-item" [class.disabled]="isLastPage">
                    <a class="page-link"
                       href="javascript:void(0)"
                       (click)="!isLastPage && onPageChange(totalPages - 1)"
                       aria-label="Dernière page">
                      <i class="bx bx-chevrons-right"></i>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>

          <!-- Info supplémentaire pagination -->
          <div class="row mt-3" *ngIf="totalElements > 0">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center text-muted font-size-12">
                <span>
                  <i class="bx bx-info-circle me-1"></i>
                  Total: {{ totalElements }} articles | Pages: {{ totalPages }}
                </span>
                <span *ngIf="statistics.totalValue > 0">
                  <i class="bx bx-money me-1"></i>
                  Valeur totale affichée: {{ formatCurrency(getDisplayedTotalValue()) }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===============================
       FOOTER AVEC RÉSUMÉ
       =============================== -->

  <div class="row mt-4" *ngIf="!loading && !error && stocks.length > 0">
    <div class="col-12">
      <div class="card bg-light">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="d-flex align-items-center gap-4 flex-wrap">
              <div class="summary-item">
                <i class="bx bx-package text-primary me-1"></i>
                <span class="fw-medium">{{ stocks.length }}</span>
                <span class="text-muted">articles affichés</span>
              </div>

              <div class="summary-item" *ngIf="selectedStocks.size > 0">
                <i class="bx bx-check-square text-info me-1"></i>
                <span class="fw-medium">{{ selectedStocks.size }}</span>
                <span class="text-muted">sélectionnés</span>
              </div>

              <div class="summary-item" *ngIf="statistics.criticalCount > 0">
                <i class="bx bx-error text-danger me-1"></i>
                <span class="fw-medium text-danger">{{ statistics.criticalCount }}</span>
                <span class="text-muted">critiques</span>
              </div>

              <div class="summary-item" *ngIf="statistics.lowCount > 0">
                <i class="bx bx-error-alt text-warning me-1"></i>
                <span class="fw-medium text-warning">{{ statistics.lowCount }}</span>
                <span class="text-muted">faibles</span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <small class="text-muted">
                <i class="bx bx-time me-1"></i>
                Dernière actualisation: {{ lastUpdate ? formatDate(lastUpdate) : 'Jamais' }}
              </small>

              <button type="button"
                      class="btn btn-outline-primary btn-sm"
                      (click)="onRefresh()"
                      [disabled]="loading">
                <i class="bx bx-refresh" [class.spinning]="loading"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===============================
       ACTIONS FLOTTANTES (MOBILE)
       =============================== -->

  <div class="floating-actions d-md-none" *ngIf="!loading && !error && stocks.length > 0">
    <div class="fab-container">
      <button type="button"
              class="btn btn-primary rounded-circle fab-main"
              data-bs-toggle="collapse"
              data-bs-target="#mobileActions"
              aria-expanded="false">
        <i class="bx bx-plus"></i>
      </button>

      <div class="collapse fab-actions" id="mobileActions">
        <button type="button"
                class="btn btn-secondary rounded-circle fab-action"
                (click)="onRefresh()"
                title="Actualiser">
          <i class="bx bx-refresh"></i>
        </button>

        <button type="button"
                class="btn btn-info rounded-circle fab-action"
                (click)="onToggleStatistics()"
                title="Statistiques">
          <i class="bx bx-bar-chart-alt-2"></i>
        </button>

        <button type="button"
                class="btn btn-success rounded-circle fab-action"
                (click)="onExport()"
                *ngIf="enableExport"
                title="Exporter">
          <i class="bx bx-download"></i>
        </button>
      </div>
    </div>
  </div>

</div>